# 知识付费视频 H5 全栈应用开发计划

## 项目架构设计

### 前端项目结构

```
frontend/
├── public/
├── src/
│   ├── api/              # API 接口封装
│   ├── assets/           # 静态资源
│   ├── components/       # 公共组件
│   ├── router/           # 路由配置
│   ├── stores/           # Pinia 状态管理
│   │   ├── user.js       # 用户模块
│   │   ├── course.js     # 课程模块
│   │   ├── play.js       # 播放模块
│   │   └── pay.js        # 支付模块
│   ├── utils/            # 工具函数
│   ├── views/            # 页面组件
│   │   ├── Home.vue      # 首页
│   │   ├── CourseDetail.vue  # 课程详情
│   │   ├── VideoPlay.vue     # 视频播放
│   │   ├── Profile.vue      # 个人中心
│   │   └── Pay.vue          # 支付弹窗
│   ├── App.vue
│   └── main.js
├── .env.development
├── .env.test
├── .env.production
├── index.html
├── package.json
├── vite.config.js
└── postcss.config.js
```

### 后端项目结构

```
backend/
├── config/               # 配置文件
│   ├── database.js       # SQLite 配置
│   ├── jwt.js            # JWT 配置
│   └── aliyun.js         # 阿里云配置
├── controllers/          # 控制器层
├── models/               # Sequelize 模型
│   ├── user.js
│   ├── course.js
│   ├── chapter.js
│   ├── order.js
│   ├── progress.js
│   └── coupon.js
├── routes/               # 路由层
├── services/             # 服务层
├── middlewares/          # 中间件
│   ├── auth.js           # JWT 认证
│   ├── validate.js       # 参数校验
│   └── rateLimit.js      # 限流
├── utils/                # 工具函数
├── database.sqlite       # SQLite 数据库文件
├── app.js                # Express 入口
└── package.json
```

## 实施步骤

### 第一阶段：项目初始化与基础配置

1. **前端初始化**

   * 创建 Vue3 + Vite 项目

   * 安装依赖：Vant UI、Pinia、Vue Router、Axios、video.js、postcss-px-to-viewport

   * 配置 Vite（别名、环境变量、样式按需引入）

   * 配置 postcss-px-to-viewport（375px 设计稿）

   * 创建基础目录结构

2. **后端初始化**

   * 创建 Node.js + Express 项目

   * 安装依赖：Sequelize、sqlite3、JWT、Joi、bcrypt、cors、express-rate-limit

   * 配置 Sequelize 连接 SQLite

   * 创建基础目录结构

### 第二阶段：数据库设计与模型创建

1. **设计 SQLite 数据表**

   * users（用户表）

   * courses（课程表）

   * chapters（章节表）

   * orders（订单表）

   * progresses（播放进度表）

   * coupons（优惠券表）

2. **创建 Sequelize 模型**

   * 定义模型字段、关联关系、索引

   * 创建数据库初始化脚本

   * 插入测试数据

### 第三阶段：后端核心接口开发

1. **用户认证模块**

   * 微信登录接口（/api/users/wxlogin）

   * 获取用户信息（/api/users/profile）

   * JWT 中间件

2. **课程模块**

   * 首页数据接口（/api/home）

   * 课程列表接口（/api/courses）

   * 课程详情接口（/api/courses/:id）

   * 章节列表接口（/api/courses/:id/chapters）

3. **视频播放模块**

   * 获取签名播放 URL（/api/videos/get-sign-url）

   * 保存播放进度（/api/videos/save-progress）

   * 校验购买权限（/api/users/check-course/:id）

4. **支付模块**

   * 创建订单（/api/orders/create）

   * 微信支付接口（/api/pay/wxpay）

   * 支付回调（/api/pay/wxpay/callback）

5. **个人中心模块**

   * 获取已购课程（/api/users/purchased）

   * 获取观看历史（/api/users/history）

   * 获取优惠券（/api/users/coupons）

### 第四阶段：前端页面开发

1. **公共组件开发**

   * 视频播放器组件（基于 video.js 二次封装）

   * 课程卡片组件

   * 支付弹窗组件

   * 加载组件

   * Toast 提示组件

2. **页面开发**

   * 首页（轮播图、分类、课程列表）

   * 课程详情页（富文本、章节列表、购买按钮）

   * 视频播放页（播放器、倍速、全屏、水印）

   * 个人中心页（用户信息、已购课程、观看历史）

3. **状态管理**

   * user store（用户信息、登录状态）

   * course store（课程列表、详情）

   * play store（播放进度、播放状态）

   * pay store（订单、支付状态）

### 第五阶段：核心功能实现

1. **微信登录**

   * 微信 JS-SDK 集成

   * 授权流程实现

   * Token 存储与刷新

2. **视频防盗播放**

   * 阿里云视频点播签名 URL 生成

   * 动态水印实现

   * 播放进度记忆

   * 试看功能（3 分钟锁定）

3. **微信 H5 支付**

   * 订单创建

   * 微信支付唤起

   * 支付回调处理

   * 订单状态更新

4. **安全防护**

   * 接口限流（IP 限流）

   * 参数校验（Joi）

   * 密码加密（bcrypt）

   * CORS 跨域配置

### 第六阶段：部署配置

1. **前端部署**

   * Vite 打包配置

   * 阿里云 OSS 上传脚本

   * CDN 加速配置

2. **后端部署**

   * PM2 进程守护配置

   * Nginx 反向代理配置

   * HTTPS 证书配置

   * 数据库备份脚本

3. **一键启动脚本**

   * 同时启动前后端服务

   * 自动连接 SQLite 数据库

### 第七阶段：文档与测试

1. **开发文档**

   * 本地开发指南

   * 接口文档（Apifox/Swagger）

   * 前后端联调指南

2. **部署文档**

   * 阿里云部署步骤

   * 微信支付对接配置

   * 阿里云点播配置

3. **测试与优化**

   * 功能测试

   * 性能优化

   * 常见问题解决方案

## 技术要点

### 关键技术实现

1. **SQLite 零配置开发**：Sequelize 自动创建 database.sqlite 文件
2. **视频防盗链**：阿里云临时签名 URL + 动态水印
3. **微信支付闭环**：下单 → 支付 → 回调 → 权限更新
4. **移动端适配**：postcss-px-to-viewport 自动转换 px 到 vw
5. **状态管理**：Pinia 模块化拆分，解耦业务逻辑

### 安全措施

* JWT 身份认证

* 接口参数校验（Joi）

* IP 限流防护

* 密码 bcrypt 加盐

* SQL 防注入（Sequelize 参数化查询）

## 交付物清单

### 前端交付物

* 完整 Vue3 项目代码

* 详细注释

* 本地运行步骤

* H5 打包教程

* 阿里云 OSS 部署步骤

* 常见问题解决方案

### 后端交付物

* 完整 Node.js 项目代码

* SQLite 初始化脚本（含测试数据）

* 接口文档（Apifox/Swagger）

* 本地开发指南

* 阿里云 ECS 部署步骤

* 微信支付/阿里云点播对接配置教程

### 全栈联调

* 前后端联调指南

* 一键启动脚本

* 接口请求/响应格式说明

